<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hacker Birthday Mission</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  background:black;
  color:#00ff9c;
  font-family:Courier New, monospace;
  overflow:hidden;
}
canvas{position:fixed;inset:0;z-index:0}
.screen{
  display:none;
  min-height:100vh;
  padding:24px;
  position:relative;
  z-index:2;
}
.active{display:block}
input,textarea,button{
  width:100%;
  margin:10px 0;
  padding:12px;
  background:black;
  border:1px solid #00ff9c;
  color:#00ff9c;
  font-family:inherit;
}
button:hover{
  background:#00ff9c;
  color:black;
  cursor:pointer;
}
h1,h2{text-shadow:0 0 10px #00ff9c}
.progress{height:6px;background:#003322}
.bar{height:100%;width:0%;background:#00ff9c;transition:.3s}
.typing{white-space:pre-line}
</style>
</head>

<body>
<canvas id="matrix"></canvas>

<!-- CREATE -->
<div class="screen active" id="create">
  <h1>ðŸŽ‚ CREATE HACKER BIRTHDAY</h1>
  <input id="name" placeholder="Target Name">
  <input id="dob" type="date">
  <textarea id="wish" placeholder="Secret birthday wish..."></textarea>
  <button id="btnCreate">GENERATE SECRET LINK</button>
  <p id="output"></p>
</div>

<!-- HACK -->
<div class="screen" id="hack">
  <h2>UNAUTHORIZED ACCESS</h2>
  <div class="typing" id="hackText"></div>
  <div class="progress"><div class="bar" id="bar"></div></div>
</div>

<!-- GAME -->
<div class="screen" id="game">
  <h2>DECRYPT MEMORY BLOCK</h2>
  <h1 id="gameCode"></h1>
  <input id="gameAnswer" placeholder="Enter decrypted code">
  <button id="btnGame">EXECUTE</button>
</div>

<!-- FINAL -->
<div class="screen" id="final">
  <h1 id="finalTitle"></h1>
  <p id="finalMsg"></p>
</div>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  doc,
  getDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBnsq6HINc_utsrxa__taeBHHdtIrCM04c",
  authDomain: "hacker-birthday.firebaseapp.com",
  projectId: "hacker-birthday",
  storageBucket: "hacker-birthday.firebasestorage.app",
  messagingSenderId: "301651147890",
  appId: "1:301651147890:web:74ab861041a60f526516eb"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= MATRIX ================= */
const c = document.getElementById("matrix");
const ctx = c.getContext("2d");
c.width = innerWidth;
c.height = innerHeight;
const chars = "01HACKBIRTHDAY";
const font = 14;
const cols = c.width / font;
const drops = Array(Math.floor(cols)).fill(1);

setInterval(()=>{
  ctx.fillStyle = "rgba(0,0,0,.05)";
  ctx.fillRect(0,0,c.width,c.height);
  ctx.fillStyle = "#00ff9c";
  ctx.font = font+"px monospace";
  drops.forEach((y,i)=>{
    const t = chars[Math.random()*chars.length|0];
    ctx.fillText(t,i*font,y*font);
    if(y*font > c.height && Math.random() > .975) drops[i]=0;
    drops[i]++;
  });
},50);

/* ================= HELPERS ================= */
function show(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function calculateAge(dob){
  const birth = new Date(dob);
  const today = new Date();
  let age = today.getFullYear() - birth.getFullYear();
  const m = today.getMonth() - birth.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
  return age;
}

/* ================= CREATE ================= */
async function createMission(){
  const name = document.getElementById("name").value;
  const dob = document.getElementById("dob").value;
  const wish = document.getElementById("wish").value;

  if(!name || !dob || !wish){
    alert("Lengkapkan semua maklumat");
    return;
  }

  const ref = await addDoc(collection(db,"missions"),{
    Name:name,
    DOB:dob,
    Wish:wish,
    createdAt:Date.now()
  });

  const link = location.origin + location.pathname + "#" + ref.id;
  document.getElementById("output").innerHTML =
    `ðŸ”— Share this link:<br><b>${link}</b>`;
}

document.getElementById("btnCreate").onclick = createMission;

/* ================= LOAD LINK ================= */
const missionId = location.hash.replace("#","");
let DATA=null;

if(missionId){
  const snap = await getDoc(doc(db,"missions",missionId));
  if(snap.exists()){
    DATA = snap.data();
    startHack();
  }
}

/* ================= HACK ================= */
const hackText = document.getElementById("hackText");
const bar = document.getElementById("bar");
const lines = [
  "Intercepting signal...",
  "Decrypting payload...",
  "Bypassing firewall...",
  "Injecting birthday.exe...",
  "ACCESS GRANTED"
];
let p=0,i=0;

function startHack(){
  show("hack");
  const iv = setInterval(()=>{
    hackText.textContent += lines[i]+"\n";
    p+=20;
    bar.style.width=p+"%";
    i++;
    if(i===lines.length){
      clearInterval(iv);
      setTimeout(startGame,800);
    }
  },600);
}

/* ================= GAME ================= */
let gameSecret="";

function startGame(){
  show("game");
  gameSecret = Math.random().toString(36).substring(2,7).toUpperCase();
  document.getElementById("gameCode").textContent = gameSecret;
  document.getElementById("gameAnswer").value="";

  setTimeout(()=>{
    document.getElementById("gameCode").textContent="â€¢â€¢â€¢â€¢â€¢";
  },2000);
}

document.getElementById("btnGame").onclick = async ()=>{
  const user = document.getElementById("gameAnswer").value.toUpperCase();
  if(user === gameSecret){
    await deleteDoc(doc(db,"missions",missionId));
    showFinal();
  }else{
    location.reload();
  }
};

/* ================= FINAL ================= */
function showFinal(){
  show("final");
  const age = calculateAge(DATA.DOB);

  document.getElementById("finalTitle").textContent =
    "ðŸŽ‰ SELAMAT HARI JADI " + DATA.Name.toUpperCase() + " ðŸŽ‰";

  document.getElementById("finalMsg").innerHTML = `
    <b>Yang ke ${age}!!</b> ðŸ¥³<br><br>
    ${DATA.Wish}<br><br>
    <b>Status:</b> LEGEND UNLOCKED
  `;
}
</script>
</body>
</html>
