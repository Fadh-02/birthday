<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hacker Birthday Mission</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;
  background:black;
  color:#00ff9c;
  font-family:Courier New, monospace;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
canvas{position:fixed; inset:0; z-index:0;}
.screen{
  display:none;
  width:90%;
  max-width:420px;
  padding:24px;
  z-index:2;
  box-sizing:border-box;
}
.active{display:block;}
input,textarea,button{
  width:100%;
  margin:10px 0;
  padding:12px;
  background:black;
  border:1px solid #00ff9c;
  color:#00ff9c;
  font-family:inherit;
  box-sizing:border-box;
}
button:hover{background:#00ff9c;color:black;cursor:pointer;}
h1,h2{text-shadow:0 0 10px #00ff9c;}
.progress{height:8px;background:#003322;margin-top:12px;}
.bar{height:100%;width:0%;background:#00ff9c;transition:.4s;}
.typing{white-space:pre-line;}
</style>
</head>
<body>
<canvas id="matrix"></canvas>

<!-- CREATE -->
<div class="screen active" id="create">
  <h1>ðŸŽ‚ CREATE HACKER BIRTHDAY</h1>
  <input id="name" placeholder="Target Name">
  <input id="dob" type="date">
  <textarea id="wish" placeholder="Secret birthday wish..."></textarea>
  <button id="btnCreate">GENERATE SECRET LINK</button>
  <p id="output"></p>
</div>

<!-- HACK -->
<div class="screen" id="hack">
  <h2>UNAUTHORIZED ACCESS</h2>
  <div class="typing" id="hackText"></div>
  <div class="progress"><div class="bar" id="hackBar"></div></div>
</div>

<!-- GAME -->
<div class="screen" id="game">
  <h2 id="gameTitle"></h2>
  <h1 id="gameQuestion"></h1>
  <div id="choices"></div>
  <div class="progress"><div class="bar" id="gameBar"></div></div>
</div>

<!-- FINAL -->
<div class="screen" id="final">
  <h1 id="finalTitle"></h1>
  <p id="finalMsg"></p>
</div>

<script type="module">
// ===== FIREBASE =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBnsq6HINc_utsrxa__taeBHHdtIrCM04c",
  authDomain: "hacker-birthday.firebaseapp.com",
  projectId: "hacker-birthday"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== ELEMENTS =====
const nameInput = document.getElementById("name");
const dobInput  = document.getElementById("dob");
const wishInput = document.getElementById("wish");
const output    = document.getElementById("output");
const btnCreate = document.getElementById("btnCreate");
const hackText  = document.getElementById("hackText");
const hackBar   = document.getElementById("hackBar");
const gameTitle = document.getElementById("gameTitle");
const gameQuestion = document.getElementById("gameQuestion");
const choices   = document.getElementById("choices");
const gameBar   = document.getElementById("gameBar");
const finalTitle = document.getElementById("finalTitle");
const finalMsg   = document.getElementById("finalMsg");

// ===== MATRIX EFFECT =====
const c=document.getElementById("matrix"),ctx=c.getContext("2d");
c.width=innerWidth;c.height=innerHeight;
const chars="01HACKBIRTHDAY",font=14;
const drops=Array(Math.floor(c.width/font)).fill(1);
setInterval(()=>{
  ctx.fillStyle="rgba(0,0,0,.05)";
  ctx.fillRect(0,0,c.width,c.height);
  ctx.fillStyle="#00ff9c";
  ctx.font=font+"px monospace";
  drops.forEach((y,i)=>{
    ctx.fillText(chars[Math.random()*chars.length|0],i*font,y*font);
    if(y*font>c.height && Math.random()>.975) drops[i]=0;
    drops[i]++;
  });
},50);

// ===== HELPERS =====
const show=id=>{
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
};

const calcAge=d=>{
  const b=new Date(d), t=new Date();
  let a=t.getFullYear()-b.getFullYear();
  if(t.getMonth()<b.getMonth() || (t.getMonth()===b.getMonth() && t.getDate()<b.getDate())) a--;
  return a;
};

const vibrate=ms=>navigator.vibrate && navigator.vibrate(ms);

// ===== SOUND =====
const ok=new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
const bad=new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

// ===== CREATE LINK =====
btnCreate.onclick = async ()=>{
  if(!nameInput.value.trim() || !dobInput.value || !wishInput.value.trim()){
    alert("Lengkapkan semua maklumat");
    return;
  }
  const ref = await addDoc(collection(db,"missions"),{
    Name: nameInput.value.trim(),
    DOB: dobInput.value,
    Wish: wishInput.value.trim()
  });
  const link = location.origin + location.pathname + "#" + ref.id;
  output.innerHTML = `ðŸ”— Share this link:<br><b>${link}</b>`;
};

// ===== INIT MISSION =====
const missionId = location.hash.replace("#","");
let DATA=null;
let step=0;
let gameQuestions=[];

if(missionId) initMission();

async function initMission(){
  show("hack");
  const snap = await getDoc(doc(db,"missions",missionId));
  if(!snap.exists()){ show("create"); return; }
  DATA = snap.data();
  startHack();
}

// ===== HACK =====
const hackLines = [
  "Intercepting signal...",
  "Decrypting payload...",
  "Bypassing firewall...",
  "Injecting birthday.exe...",
  "ACCESS GRANTED"
];
let hi=0;
function startHack(){
  hackText.textContent="";
  hackBar.style.width="0%";
  hi=0;
  const iv=setInterval(()=>{
    hackText.textContent += hackLines[hi] + "\n";
    hackBar.style.width = ((hi+1)/hackLines.length*100)+"%";
    hi++;
    if(hi===hackLines.length){
      clearInterval(iv);
      setTimeout(startGame,700);
    }
  },600);
}

// ===== GAME QUESTIONS POOL =====
const questionPools = [
  {q:"2 + 3 Ã— 2 = ?", c:["10","8","12"], a:1},
  {q:"Apakah nombor seterusnya? 2 â†’ 6 â†’ 12 â†’ 20 â†’ ?", c:["28","30","32"], a:1},
  {q:"Apakah seterusnya? A â†’ C â†’ F â†’ J â†’ ?", c:["M","N","O"], a:1},
  {q:"Jika lima burung bertenggek di atas pokok dan dua terbang pergi, berapa yang tinggal?", c:["2","3","5"], a:1},
  {q:"Saya semakin banyak kau kongsi, saya semakin hilang. Apakah saya?", c:["Rahsia","Makanan","Air"], a:0},
  {q:"Semakin kau simpan aku, semakin aku hilang. Apakah aku?", c:["Rahsia","Memori","Fail"], a:0},
  {q:"Aku sentiasa ada di hadapanmu, tetapi kau tak boleh melihat aku. Siapakah aku?", c:["Masa depan","Bayang","Udara"], a:0},
  {q:"Apakah nombor ganjil ke-10 dalam siri 1,3,5,7,...?", c:["19","20","21"], a:0},
  {q:"Aku mempunyai kunci tetapi tiada pintu. Apakah aku?", c:["Piano","Peti","Rumah"], a:0},
  {q:"Perkataan apakah tetap sama walaupun dibaca terbalik?", c:["LEVEL","MALAY","CODE"], a:0},
  {q:"Empat orang berdiri dalam barisan. Jika A di depan B, dan C di belakang D, siapakah di tengah?", c:["B","C","D"], a:1},
  {q:"Jika 3 pensil + 2 buku = 23 dan 2 pensil + 3 buku = 24, berapa harga 1 pensil?", c:["4","5","6"], a:0},
  {q:"Aku naik tetapi tidak bergerak, aku turun tetapi tidak jatuh. Apakah aku?", c:["Suhu","Tangga","Lif"], a:0},
  {q:"Siri huruf: Z, X, V, T, ? Apa huruf seterusnya?", c:["R","S","U"], a:0},
  {q:"Saya mula dengan 'E', berakhir dengan 'E', dan mengandungi satu huruf di tengah. Apakah saya?", c:["Envelope","Eye","Edge"], a:1}
];


function shuffleArray(arr){return arr.sort(()=>Math.random()-0.5);}

function generateFinalBoss(name){
  const letters = name.replace(/\s+/g,"").toUpperCase();
  const count = letters.length;
  return {q:`Final Boss ðŸŽ¯: Nama sasaran mengandungi berapa huruf (tanpa ruang)?`, c:[String(count-1), String(count), String(count+1)], a:1};
}

// ===== START GAME =====
function startGame(){
  step = 0;
  gameQuestions = shuffleArray([...questionPools]).slice(0,3); // 3 random
  gameQuestions.push(generateFinalBoss(DATA.Name)); // final boss
  show("game");
  loadGame();
}

// ===== LOAD GAME =====
function loadGame(){
  const q = gameQuestions[step];
  gameTitle.textContent = `SECURITY ${step+1}/${gameQuestions.length}`;
  gameQuestion.textContent = q.q;
  gameBar.style.width = (step/gameQuestions.length*100)+"%";
  choices.innerHTML = "";

  q.c.forEach((txt,i)=>{
    const b = document.createElement("button");
    b.textContent = txt;
    b.onclick = async ()=>{
      if(i===q.a){
        ok.play(); vibrate(120);
        step++;
        if(step < gameQuestions.length) loadGame();
        else{
          await deleteDoc(doc(db,"missions",missionId));
          showFinal();
        }
      }else{
        bad.play(); vibrate(400);
        location.reload();
      }
    };
    choices.appendChild(b);
  });
}

// ===== FINAL =====
function showFinal(){
  show("final");
  finalTitle.textContent = `ðŸŽ‰ SELAMAT HARI JADI ${DATA.Name.toUpperCase()} ðŸŽ‰`;
  finalMsg.innerHTML = `
    <b>Yang ke ${calcAge(DATA.DOB)}!!</b><br><br>
    ${DATA.Wish}<br><br>
    <b>Status:</b> MISSION COMPLETE
  `;
}
</script>
</body>
</html>

