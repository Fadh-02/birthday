<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hacker Birthday Mission</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;
  background:black;
  color:#00ff9c;
  font-family:Courier New, monospace;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
canvas{position:fixed; inset:0; z-index:0;}
.screen{
  display:none;
  width:92%;
  max-width:420px;
  padding:24px;
  z-index:2;
  box-sizing:border-box;
  text-align:center;
}
.active{display:block;}
input,textarea,button{
  width:100%;
  margin:10px 0;
  padding:12px;
  background:black;
  border:1px solid #00ff9c;
  color:#00ff9c;
  font-family:inherit;
}
button:hover{background:#00ff9c;color:black;cursor:pointer;}
.progress{height:8px;background:#003322;margin-top:14px;}
.bar{height:100%;width:0%;background:#00ff9c;transition:.4s;}
.typing{white-space:pre-line;}
</style>
</head>

<body>
<canvas id="matrix"></canvas>

<!-- CREATE -->
<div class="screen active" id="create">
  <h1>üéÇ CREATE HACKER BIRTHDAY</h1>
  <input id="name" placeholder="Target Name">
  <input id="dob" type="date">
  <textarea id="wish" placeholder="Secret birthday wish..."></textarea>
  <button id="btnCreate">GENERATE SECRET LINK</button>
  <p id="output"></p>
</div>

<!-- HACK -->
<div class="screen" id="hack">
  <h2>UNAUTHORIZED ACCESS</h2>
  <div class="typing" id="hackText"></div>
  <div class="progress"><div class="bar" id="hackBar"></div></div>
</div>

<!-- GAME -->
<div class="screen" id="game">
  <h2 id="gameTitle"></h2>
  <h1 id="gameQuestion"></h1>
  <div id="choices"></div>
  <div class="progress"><div class="bar" id="gameBar"></div></div>
</div>

<!-- FINAL -->
<div class="screen" id="final">
  <h1 id="finalTitle"></h1>
  <p id="finalMsg"></p>
</div>

<!-- DEAD -->
<div class="screen" id="dead">
  <h1>‚ò†Ô∏è LINK EXPIRED</h1>
  <p>This mission has self‚Äëdestructed.</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBnsq6HINc_utsrxa__taeBHHdtIrCM04c",
  authDomain: "hacker-birthday.firebaseapp.com",
  projectId: "hacker-birthday"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ELEMENTS
const screens = document.querySelectorAll(".screen");
const show = id => screens.forEach(s=>s.classList.toggle("active", s.id===id));

const nameInput = document.getElementById("name");
const dobInput  = document.getElementById("dob");
const wishInput = document.getElementById("wish");
const output    = document.getElementById("output");

const hackText = document.getElementById("hackText");
const hackBar  = document.getElementById("hackBar");

const gameTitle = document.getElementById("gameTitle");
const gameQuestion = document.getElementById("gameQuestion");
const choices = document.getElementById("choices");
const gameBar = document.getElementById("gameBar");

const finalTitle = document.getElementById("finalTitle");
const finalMsg = document.getElementById("finalMsg");

// MATRIX
const c=document.getElementById("matrix"),ctx=c.getContext("2d");
c.width=innerWidth;c.height=innerHeight;
const chars="01HACKBIRTHDAY";
const font=14;
const drops=Array(Math.floor(c.width/font)).fill(1);
setInterval(()=>{
  ctx.fillStyle="rgba(0,0,0,.05)";
  ctx.fillRect(0,0,c.width,c.height);
  ctx.fillStyle="#00ff9c";
  ctx.font=font+"px monospace";
  drops.forEach((y,i)=>{
    ctx.fillText(chars[Math.random()*chars.length|0],i*font,y*font);
    if(y*font>c.height && Math.random()>.975) drops[i]=0;
    drops[i]++;
  });
},50);

// HELPERS
const calcAge=d=>{
  const b=new Date(d),t=new Date();
  let a=t.getFullYear()-b.getFullYear();
  if(t.getMonth()<b.getMonth() || (t.getMonth()===b.getMonth() && t.getDate()<b.getDate())) a--;
  return a;
};
const vibrate=ms=>navigator.vibrate&&navigator.vibrate(ms);
const ok=new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
const bad=new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

// CREATE
btnCreate.onclick = async ()=>{
  if(!nameInput.value||!dobInput.value||!wishInput.value){
    alert("Lengkapkan semua maklumat");
    return;
  }
  const ref=await addDoc(collection(db,"missions"),{
    name:nameInput.value.trim(),
    dob:dobInput.value,
    wish:wishInput.value.trim(),
    used:false
  });
  output.innerHTML=`üîó Share link:<br><b>${location.origin+location.pathname+"#"+ref.id}</b>`;
};

// INIT
const missionId=location.hash.slice(1);
let DATA=null,step=0,questions=[];

if(missionId) initMission();

async function initMission(){
  show("hack");
  const ref=doc(db,"missions",missionId);
  const snap=await getDoc(ref);
  if(!snap.exists()||snap.data().used){
    show("dead");
    return;
  }
  DATA=snap.data();
  startHack();
}

// HACK
const hackLines=[
  "Intercepting signal...",
  "Decrypting payload...",
  "Bypassing firewall...",
  "Injecting birthday.exe...",
  "ACCESS GRANTED"
];
let hi=0;
function startHack(){
  hackText.textContent="";
  hackBar.style.width="0%";
  hi=0;
  const iv=setInterval(()=>{
    hackText.textContent+=hackLines[hi]+"\n";
    hackBar.style.width=((hi+1)/hackLines.length*100)+"%";
    hi++;
    if(hi===hackLines.length){
      clearInterval(iv);
      setTimeout(startGame,700);
    }
  },600);
}

// QUESTIONS
const pool=[
  {q:"2 + 3 √ó 2 = ?",c:["10","8","12"],a:1},
  {q:"2 ‚Üí 6 ‚Üí 12 ‚Üí 20 ‚Üí ?",c:["28","30","32"],a:1},
  {q:"A ‚Üí C ‚Üí F ‚Üí J ‚Üí ?",c:["M","N","O"],a:1},
  {q:"Semakin dikongsi semakin hilang?",c:["Rahsia","Air","Masa"],a:0},
  {q:"Aku ada kunci tapi tiada pintu?",c:["Piano","Rumah","Kereta"],a:0},
  {q:"LEVEL dibaca terbalik jadi?",c:["LEVEL","LEBEL","VLEVEL"],a:0}
];

const shuffle=a=>a.sort(()=>Math.random()-0.5);

const finalBoss=name=>{
  const n=name.replace(/\s/g,"").length;
  return {q:"FINAL BOSS üéØ: Berapa huruf nama sasaran (tanpa ruang)?",
          c:[n-1+"",n+"",n+1+""],a:1};
};

function startGame(){
  step=0;
  questions=shuffle([...pool]).slice(0,3);
  questions.push(finalBoss(DATA.name));
  show("game");
  loadGame();
}

function loadGame(){
  const q=questions[step];
  gameTitle.textContent=`SECURITY ${step+1}/${questions.length}`;
  gameQuestion.textContent=q.q;
  gameBar.style.width=(step/questions.length*100)+"%";
  choices.innerHTML="";
  q.c.forEach((t,i)=>{
    const b=document.createElement("button");
    b.textContent=t;
    b.onclick=async()=>{
      if(i===q.a){
        ok.play();vibrate(120);
        step++;
        if(step<questions.length) loadGame();
        else{
          await updateDoc(doc(db,"missions",missionId),{used:true});
          showFinal();
        }
      }else{
        bad.play();vibrate(400);
        location.reload();
      }
    };
    choices.appendChild(b);
  });
}

function showFinal(){
  show("final");
  finalTitle.textContent=`üéâ HAPPY BIRTHDAY ${DATA.name.toUpperCase()} üéâ`;
  finalMsg.innerHTML=`Umur: <b>${calcAge(DATA.dob)}</b><br><br>${DATA.wish}<br><br><b>MISSION COMPLETE</b>`;
}
</script>
</body>
</html>
