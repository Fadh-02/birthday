<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hacker Birthday Mission</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  background:black;
  color:#00ff9c;
  font-family:Courier New, monospace;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}

canvas{
  position:fixed;
  inset:0;
  z-index:0;
}

.screen{
  display:none;
  width:90%;
  max-width:420px;
  padding:24px;
  z-index:2;
  box-sizing:border-box;
  text-align:center;
}

.active{display:block}

input,textarea,button{
  width:100%;
  margin:10px 0;
  padding:12px;
  background:black;
  border:1px solid #00ff9c;
  color:#00ff9c;
  font-family:inherit;
}

button:hover{
  background:#00ff9c;
  color:black;
  cursor:pointer;
}

h1,h2{text-shadow:0 0 10px #00ff9c}

.progress{
  height:8px;
  background:#003322;
  margin-top:12px;
}

.bar{
  height:100%;
  width:0%;
  background:#00ff9c;
  transition:.4s;
}

.typing{white-space:pre-line}
</style>
</head>

<body>
<canvas id="matrix"></canvas>

<!-- CREATE -->
<div class="screen active" id="create">
  <h1>ðŸŽ‚ CREATE HACKER BIRTHDAY</h1>
  <input id="name" placeholder="Target Name">
  <input id="dob" type="date">
  <textarea id="wish" placeholder="Secret birthday wish..."></textarea>
  <button id="btnCreate">GENERATE SECRET LINK</button>
  <p id="output"></p>
</div>

<!-- HACK -->
<div class="screen" id="hack">
  <h2>UNAUTHORIZED ACCESS</h2>
  <div class="typing" id="hackText"></div>
  <div class="progress"><div class="bar" id="hackBar"></div></div>
</div>

<!-- GAME -->
<div class="screen" id="game">
  <h2 id="gameTitle"></h2>
  <h1 id="gameQuestion"></h1>
  <div id="choices"></div>
  <div class="progress"><div class="bar" id="gameBar"></div></div>
</div>

<!-- FINAL -->
<div class="screen" id="final">
  <h1 id="finalTitle"></h1>
  <p id="finalMsg"></p>
</div>

<!-- DEAD LINK -->
<div class="screen" id="dead">
  <h1>ðŸš« LINK EXPIRED</h1>
  <p>
    This mission has already been completed.<br><br>
    <b>Status:</b> ACCESS TERMINATED
  </p>
</div>

<script type="module">
/* ========= FIREBASE ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  doc,
  getDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBnsq6HINc_utsrxa__taeBHHdtIrCM04c",
  authDomain: "hacker-birthday.firebaseapp.com",
  projectId: "hacker-birthday"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ========= HELPERS ========= */
const show = id => {
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
};

const calcAge = d => {
  const b=new Date(d), t=new Date();
  let a=t.getFullYear()-b.getFullYear();
  if(t.getMonth()<b.getMonth() || (t.getMonth()==b.getMonth() && t.getDate()<b.getDate())) a--;
  return a;
};

const vibrate = ms => navigator.vibrate && navigator.vibrate(ms);

/* ========= SOUND ========= */
const ok = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
const bad = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

/* ========= MATRIX ========= */
const c=document.getElementById("matrix"),ctx=c.getContext("2d");
c.width=innerWidth;c.height=innerHeight;
const chars="01HACKBIRTHDAY",font=14;
const drops=Array(Math.floor(c.width/font)).fill(1);

setInterval(()=>{
  ctx.fillStyle="rgba(0,0,0,.05)";
  ctx.fillRect(0,0,c.width,c.height);
  ctx.fillStyle="#00ff9c";
  ctx.font=font+"px monospace";
  drops.forEach((y,i)=>{
    ctx.fillText(chars[Math.random()*chars.length|0],i*font,y*font);
    if(y*font>c.height&&Math.random()>.975)drops[i]=0;
    drops[i]++;
  });
},50);

/* ========= CREATE ========= */
btnCreate.onclick = async () => {
  if(!name.value || !dob.value || !wish.value){
    alert("Lengkapkan semua maklumat");
    return;
  }

  const ref = await addDoc(collection(db,"missions"),{
    Name:name.value,
    DOB:dob.value,
    Wish:wish.value
  });

  output.innerHTML = `ðŸ”— Share link:<br><b>${location.origin+location.pathname+"#"+ref.id}</b>`;
};

/* ========= INIT ========= */
const missionId = location.hash.replace("#","");
let DATA=null;

if(missionId) initMission();

async function initMission(){
  show("hack");
  const snap = await getDoc(doc(db,"missions",missionId));

  if(!snap.exists()){
    show("dead");
    return;
  }

  DATA = snap.data();
  startHack();
}

/* ========= HACK ========= */
const hackLines=[
  "Intercepting signal...",
  "Decrypting payload...",
  "Bypassing firewall...",
  "Injecting birthday.exe...",
  "ACCESS GRANTED"
];

function startHack(){
  let i=0;
  hackText.textContent="";
  const iv=setInterval(()=>{
    hackText.textContent+=hackLines[i]+"\n";
    hackBar.style.width=((i+1)/hackLines.length*100)+"%";
    i++;
    if(i===hackLines.length){
      clearInterval(iv);
      setTimeout(startGame,700);
    }
  },600);
}

/* ========= QUESTIONS ========= */
const easy=[
  {q:"2 â†’ 6 â†’ 12 â†’ 20 â†’ ?",c:["28","30","32"],a:0},
  {q:"A â†’ C â†’ F â†’ J â†’ ?",c:["M","N","O"],a:1}
];
const medium=[
  {q:"0x2A dalam perpuluhan?",c:["32","42","64"],a:1},
  {q:"0x10 + 0x10 = ?",c:["16","32","48"],a:1}
];
const hard=[
  {q:"Semakin disimpan, semakin hilang?",c:["Rahsia","Fail","Memori"],a:0},
  {q:"Ada di depan, tak boleh dilihat?",c:["Masa depan","Udara","Bayang"],a:0}
];

function pick(arr){return arr[Math.random()*arr.length|0];}

function finalBoss(name){
  const len=name.replace(/\s+/g,"").length;
  return {
    q:`FINAL BOSS ðŸŽ¯<br>Nama sasaran ada berapa huruf?`,
    c:[len-1,len,len+1].map(String),
    a:1
  };
}

/* ========= GAME ========= */
let game=[],step=0;

function startGame(){
  game=[
    pick(easy),
    pick(medium),
    pick(hard),
    finalBoss(DATA.Name)
  ];
  step=0;
  show("game");
  loadGame();
}

function loadGame(){
  const q=game[step];
  gameTitle.innerHTML= step<3 ? `SECURITY ${step+1}/3` : "FINAL BOSS ðŸ’€";
  gameQuestion.innerHTML=q.q;
  gameBar.style.width=(step/4*100)+"%";
  choices.innerHTML="";

  q.c.forEach((txt,i)=>{
    const b=document.createElement("button");
    b.textContent=txt;
    b.onclick=async()=>{
      if(i===q.a){
        ok.play();vibrate(120);
        step++;
        if(step<4) loadGame();
        else{
          await deleteDoc(doc(db,"missions",missionId));
          showFinal();
        }
      }else{
        bad.play();vibrate(400);
        location.reload();
      }
    };
    choices.appendChild(b);
  });
}

/* ========= FINAL ========= */
function showFinal(){
  show("final");
  finalTitle.textContent=`ðŸŽ‰ HAPPY BIRTHDAY ${DATA.Name.toUpperCase()} ðŸŽ‰`;
  finalMsg.innerHTML=`
    <b>${calcAge(DATA.DOB)} YEARS OLD</b><br><br>
    ${DATA.Wish}<br><br>
    <b>Status:</b> MISSION COMPLETE
  `;
}
</script>
</body>
</html>
